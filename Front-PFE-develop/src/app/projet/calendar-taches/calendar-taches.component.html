<div class="archive-container">
  <app-sidebar></app-sidebar>

  <div class="main-content">
    <app-topbar></app-topbar>

    <div class="content-wrapper">
      <!-- Calendrier -->
      <div class="calendar-wrapper">
        <div class="calendar-container">
          <button 
            class="btn availability-toggle" 
            [ngClass]="{'btn-outline': !showUserAvailability, 'btn-primary': showUserAvailability}"
            (click)="toggleUserAvailability()">
            <i class="fas fa-users"></i> Disponibilité utilisateurs
          </button>
        </div>
      </div>


      <!-- Vue de la disponibilité des utilisateurs (si activée) -->
      <div *ngIf="showUserAvailability" class="user-availability-section">
        <app-user-availability 
          [taches]="taches" 
          [selectedDate]="selectedDate">
        </app-user-availability>
      </div>

      <div class="full-calendar-container">
        <full-calendar [options]="calendarOptions"></full-calendar>
      </div>

      <!-- Liste des tâches sans date -->
      <div class="taches-sans-date-container">
        <div class="taches-sans-date">
          <h3><i class="fas fa-tasks"></i> Tâches sans date</h3>
          <div *ngFor="let tache of tachesSansDate" 
               class="tache-draggable" 
               [attr.data-tache-id]="tache.id"
               (mousedown)="makeTaskDraggable($event)">
            <div class="tache-content">
              <strong>{{ tache.titre }}</strong>
              <p class="tache-description">{{ tache.description }}</p>
            </div>
            <button type="button" class="btn-remove-dates" 
                    (click)="removeTacheDates(tache.id)">
              <i class="fas fa-trash-alt"></i> Supprimer dates
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Popup de création de tâche -->
    <div class="overlay" *ngIf="showPopup && !selectedTache">
      <div class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> Nouvelle Tâche</h2>
            <button class="close-btn" (click)="closePopup()">&times;</button>
          </div>

          <form (ngSubmit)="createTache()" class="tache-form">
            <div class="form-row">
              <div class="form-group">
                <label for="titre">Titre :</label>
                <input id="titre" name="titre" type="text" class="form-control" [(ngModel)]="tache.titre" required />
              </div>

              <div class="form-group">
                <label for="statut">Statut :</label>
                <select id="statut" name="statut" class="form-control" [(ngModel)]="tache.statut">
                  <option value="EN_ATTENTE">En attente</option>
                  <option value="EN_COURS">En cours</option>
                  <option value="TERMINEE">Terminé</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="description">Description :</label>
              <textarea id="description" name="description" class="form-control" [(ngModel)]="tache.description"></textarea>
            </div>

            <div class="form-group">
              <label for="commentaires">Commentaires :</label>
              <textarea id="commentaires" name="commentaires" class="form-control" [(ngModel)]="tache.commentaires"></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="dateDebut">Date Début :</label>
                <input id="dateDebut" name="dateDebut" type="datetime-local" class="form-control"
                       [value]="tache.dateDebut ? formatToDateTimeLocal(tache.dateDebut) : ''"
                       (change)="onDateDebutChange($event)" required />
              </div>

              <div class="form-group">
                <label for="dateFin">Date Fin :</label>
                <input id="dateFin" name="dateFin" type="datetime-local" class="form-control"
                       [(ngModel)]="tache.dateFin" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="projet">Projet :</label>
                <select id="projet" [(ngModel)]="selectedProjetId" name="projet" class="form-control">
                  <option [value]="null">-- Choisir un projet --</option>
                  <option *ngFor="let projet of projets" [value]="projet.id">
                    {{ projet.title }}
                  </option>
                </select>
              </div>

              <div class="form-group">
                <label for="categorie">Catégorie :</label>
                <input id="categorie" name="categorie" type="text" class="form-control" [(ngModel)]="tache.categorie" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="priorite">Priorité :</label>
                <select id="priorite" name="priorite" class="form-control" [(ngModel)]="tache.priorite">
                  <option value="NORMALE">Normale</option>
                  <option value="HAUTE">Haute</option>
                  <option value="BASSE">Basse</option>
                </select>
              </div>

            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="tempsEstime">Temps estimé (h) :</label>
                <input id="tempsEstime" name="tempsEstime" type="number" class="form-control" [(ngModel)]="tache.tempsEstime" />
              </div>

              <div class="form-group">
                <label for="tempsPasse">Temps passé (h) :</label>
                <input id="tempsPasse" name="tempsPasse" type="number" class="form-control" [(ngModel)]="tache.tempsPasse" />
              </div>
            </div>

            <div class="form-group">
              <label for="fullName">Assigné à :</label>
              <input id="fullName" name="fullName" class="form-control" [(ngModel)]="tache.fullName"/>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-cancel" (click)="closePopup()">
                <i class="fas fa-times"></i> Annuler
              </button>
              <button type="submit" class="btn btn-submit">
                <i class="fas fa-check"></i> Créer
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
<button class="btn btn-success" (click)="allerVersStatistiques()">
  <i class="fas fa-chart-bar"></i> Statistiques
</button>
    <!-- Popup détails de la tâche -->
    <div class="overlay" *ngIf="selectedTache">
      <div class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Détails de la tâche</h2>
            <button class="close-btn" (click)="closePopup()">&times;</button>
          </div>
          
          <div class="tache-details">
            <div class="detail-row">
              <span class="detail-label">Titre :</span>
              <span class="detail-value">{{ selectedTache.titre }}</span>
            </div>
            
            <div class="detail-row">
              <span class="detail-label">Description :</span>
              <span class="detail-value">{{ selectedTache.description }}</span>
            </div>
            
            <div class="detail-row">
              <span class="detail-label">Statut :</span>
              <span class="detail-value badge" [ngClass]="{
                'badge-warning': selectedTache.statut === 'EN_ATTENTE',
                'badge-primary': selectedTache.statut === 'EN_COURS',
                'badge-success': selectedTache.statut === 'TERMINEE'
              }">
                {{ selectedTache.statut }}
              </span>
            </div>
            
            <div class="detail-row">
              <span class="detail-label">Dates :</span>
              <span class="detail-value">
                {{ selectedTache.dateDebut | date:'dd/MM/yyyy HH:mm' }} - 
                {{ selectedTache.dateFin | date:'dd/MM/yyyy HH:mm' }}
              </span>
            </div>
            
            <div class="detail-row">
              <span class="detail-label">Projet :</span>
              <span class="detail-value">{{ selectedTache.projet?.title || 'Non assigné' }}</span>
            </div>
            
            <div class="detail-row">
              <span class="detail-label">Priorité :</span>
              <span class="detail-value badge" [ngClass]="{
                'badge-danger': selectedTache.priorite === 'HAUTE',
                'badge-info': selectedTache.priorite === 'NORMALE',
                'badge-secondary': selectedTache.priorite === 'BASSE'
              }">
                {{ selectedTache.priorite }}
              </span>
            </div>
            
            <div class="detail-row">
              <span class="detail-label">Temps :</span>
              <span class="detail-value">
                Estimé: {{ selectedTache.tempsEstime }}h | 
                Passé: {{ selectedTache.tempsPasse }}h
              </span>
            </div>
            
            <div class="detail-row">
              <span class="detail-label">Assigné à :</span>
              <span class="detail-value">{{ selectedTache.fullName || 'Non assigné' }}</span>
            </div>
            
        
          
          <div class="modal-footer">
            <button class="btn btn-close" (click)="closePopup()">
              <i class="fas fa-times"></i> Fermer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
</div>